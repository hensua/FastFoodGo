
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /*********************************************************************
     *                                                                   *
     *                      HELPER FUNCTIONS                             *
     *                                                                   *
     *********************************************************************/

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }
    
    function isDeveloper() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'developer';
    }

    function isHost() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'host';
    }

    function isAdminOrDevOrHost() {
      let userRole = getUserRole(request.auth.uid);
      return isSignedIn() && (userRole == 'admin' || userRole == 'developer' || userRole == 'host');
    }
    
    function isDriver() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'driver';
    }


    /*********************************************************************
     *                                                                   *
     *                        TOP-LEVEL COLLECTIONS                      *
     *                                                                   *
     *********************************************************************/
    
    /**
     * @description
     *   Stores the restaurant's product catalog. Publicly readable, but only
     *   administrators and developers can manage products.
     */
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdminOrDevOrHost();
    }
    
    /**
     * @description
     * Stores public user information.
     * - Users can create and manage their own profile.
     * - Admins and Developers can list and manage all users.
     * - Hosts can list users only when filtered by role 'driver'.
     */
     match /users/{userId} {
        allow get: if isSignedIn();
        allow list: if isAdminOrDevOrHost();
        allow create: if isOwner(userId);
        allow update: if isOwner(userId) || isAdminOrDevOrHost();
        allow delete: if isAdminOrDevOrHost();
     }

    /**
     * @description
     *   A user's order history, stored in a private subcollection.
     */
    match /users/{userId}/orders/{orderId} {
      function getOrder() {
        return get(/databases/$(database)/documents/users/$(userId)/orders/$(orderId));
      }
      function isOrderDriver() {
        return isDriver() && getOrder().data.driverId == request.auth.uid;
      }
      
      allow get: if isOwner(userId) || isAdminOrDevOrHost() || isOrderDriver();
      allow list: if isOwner(userId) || isAdminOrDevOrHost();
      allow create: if isOwner(userId);
      allow update: if 
            // The customer can only cancel their own order if it's 'pending'.
            (isOwner(userId) && request.resource.data.status == 'cancelled' && resource.data.status == 'pending') ||
            // Admin, Developer or Host can manage most order state transitions.
            isAdminOrDevOrHost() ||
            // An assigned driver can update the status to 'delivering' or 'delivered'.
            (isOrderDriver() && (
                  (resource.data.status == 'ready' && request.resource.data.status == 'delivering') ||
                  (resource.data.status == 'delivering' && request.resource.data.status == 'delivered' && resource.data.pin == request.resource.data.pin)
                )
            );
      allow delete: if isAdminOrDevOrHost();

      match /messages/{messageId} {
        allow read, write: if isOwner(userId) || isAdminOrDevOrHost() || isOrderDriver();
      }
    }
    
    /**
     * @description
     *   This rule is for the `collectionGroup` query on 'orders'.
     *   It allows administrators, developers, hosts, and drivers to list orders across all users,
     *   which is necessary for their respective panels.
     */
    match /{path=**}/orders/{orderId} {
       allow list: if isAdminOrDevOrHost() || isDriver();
    }
  }
}
