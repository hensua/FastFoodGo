
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /*********************************************************************
     *                                                                   *
     *                      HELPER FUNCTIONS                             *
     *                                                                   *
     *********************************************************************/

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserRole(userId) {
      // Use .get('role', 'customer') to provide a default value and avoid errors
      // if the role field doesn't exist on a user document.
      return get(/databases/$(database)/documents/users/$(userId)).data.get('role', 'customer');
    }

    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }
    
    function isHost() {
        return isSignedIn() && getUserRole(request.auth.uid) == 'host';
    }
    
    function isDriver() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'driver';
    }

    function isDeveloper() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'developer';
    }


    /*********************************************************************
     *                                                                   *
     *                        TOP-LEVEL COLLECTIONS                      *
     *                                                                   *
     *********************************************************************/
    
    /**
     * @description
     *   Stores the restaurant's product catalog. Publicly readable, but only
     *   administrators can manage products.
     */
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    /**
     * @description
     * Stores public user information.
     */
     match /users/{userId} {
        // Any signed-in user can view their own profile.
        allow get: if isOwner(userId);
        
        // Admins and Developers can list all users for management panels.
        // Hosts can list users, but ONLY if they are filtering for 'driver' role.
        allow list: if isAdmin() || isDeveloper() || (isHost() && request.query.where.role == 'driver');
        
        // A user can create their own document.
        allow create: if isOwner(userId);
        
        // A user can update their own profile.
        // Admins and Developers can update any user profile (for role changes).
        allow update: if isOwner(userId) || isAdmin() || isDeveloper();
        
        // Only admins can delete users.
        allow delete: if isAdmin();
     }

    /**
     * @description
     *   A user's order history, stored in a private subcollection.
     */
    match /users/{userId}/orders/{orderId} {
      function getOrder() {
        return get(/databases/$(database)/documents/users/$(userId)/orders/$(orderId));
      }
      function isOrderDriver() {
        return isDriver() && getOrder().data.driverId == request.auth.uid;
      }
      
      allow get: if isOwner(userId) || isAdmin() || isHost() || isOrderDriver();
      allow list: if isOwner(userId) || isAdmin() || isHost();
      allow create: if isOwner(userId);
      allow update: if 
            // The customer can only cancel their own order if it's 'pending'.
            (isOwner(userId) && request.resource.data.status == 'cancelled' && resource.data.status == 'pending') ||
            // Admin or Host can manage most order state transitions.
            isAdmin() || isHost() ||
            // An assigned driver can update the status to 'delivering' or 'delivered'.
            (isOrderDriver() && (
                  (resource.data.status == 'ready' && request.resource.data.status == 'delivering') ||
                  (resource.data.status == 'delivering' && request.resource.data.status == 'delivered' && resource.data.pin == request.resource.data.pin)
                )
            );
      allow delete: if isAdmin();

      match /messages/{messageId} {
        allow read, write: if isOwner(userId) || isAdmin() || isHost() || isOrderDriver();
      }
    }
    
    /**
     * @description
     *   This rule is for the `collectionGroup` query on 'orders'.
     *   It allows administrators, hosts, and drivers to list orders across all users,
     *   which is necessary for their respective panels.
     */
    match /{path=**}/orders/{orderId} {
       allow list: if isAdmin() || isHost() || isDriver();
    }
  }
}
